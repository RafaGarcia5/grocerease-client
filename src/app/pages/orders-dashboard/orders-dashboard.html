<main class="orders-container">
    <div class="dashboard-title">
        <h1>Orders Management</h1>
    </div>

  <div class="dashboard-filters">
    <mat-form-field class="search-input" appearance="outline">
      <input matInput placeholder="Search by customer or order #" [(ngModel)]="searchTerm" (keyup.enter)="onSearch()" />
    </mat-form-field>

    <div class="sort-actions">
      <mat-form-field class="select-input" appearance="outline">
          <mat-select [(ngModel)]="sortBy" (selectionChange)="loadOrders(1)">
              <mat-option value="order_date">Order Date</mat-option>
              <mat-option value="status">Status</mat-option>
              <mat-option value="user_id">Customer</mat-option>
          </mat-select>
      </mat-form-field>
  
      <mat-form-field class="select-input" appearance="outline">
          <mat-select [(ngModel)]="sortDir" (selectionChange)="loadOrders(1)">
              <mat-option value="asc">Asc</mat-option>
              <mat-option value="desc">Desc</mat-option>
          </mat-select>
      </mat-form-field>
  
      <button matButton="filled" (click)="onSearch()">
        @if (loading()) {
          <span>Searching...</span>
        }@else {
          <span>Search</span>
        }
      </button>
    </div>
  </div>

  <div class="order-table">
    <table mat-table [dataSource]="orders" multiTemplateDataRows class="mat-elevation-z8">

      <ng-container matColumnDef="#">
        <th mat-header-cell *matHeaderCellDef>#</th>
        <td mat-cell *matCellDef="let order">
          {{ orders.indexOf(order) + 1 + pageIndex * pageSize }}
        </td>
      </ng-container>
  
      <ng-container matColumnDef="customer">
        <th mat-header-cell *matHeaderCellDef>Customer</th>
        <td mat-cell *matCellDef="let order">{{ order.user?.email || 'N/A' }}</td>
      </ng-container>
  
      <ng-container matColumnDef="order">
        <th mat-header-cell *matHeaderCellDef >Order #</th>
        <td mat-cell *matCellDef="let order">{{ order.id }}</td>
      </ng-container>
  
      <ng-container matColumnDef="order_date">
        <th mat-header-cell *matHeaderCellDef>Date</th>
        <td mat-cell *matCellDef="let order">{{ order.order_date | date }}</td>
      </ng-container>
  
      <ng-container matColumnDef="amount">
        <th mat-header-cell *matHeaderCellDef>Amount</th>
        <td mat-cell *matCellDef="let order">{{ order.total | currency }}</td>
      </ng-container>
  
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef>Status</th>
        <td mat-cell *matCellDef="let order">
          <mat-select [value]="order.status" (selectionChange)="changeStatus(order, $event.value)" (click)="$event.stopPropagation()">
            <mat-option value="pending">Pending</mat-option>
            <mat-option value="send">Send</mat-option>
            <mat-option value="delivered">Delivered</mat-option>
            <mat-option value="cancel">Cancel</mat-option>
          </mat-select>
        </td>
      </ng-container>
  
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Actions</th>
        <td mat-cell *matCellDef="let order">
          <button mat-button class="btn-warn" (click)="changeStatus(order, 'cancel'); $event.stopPropagation()">Cancel</button>
        </td>
      </ng-container>

      <ng-container matColumnDef="expand">
        <th mat-header-cell *matHeaderCellDef aria-label="row actions">&nbsp;</th>
        <td mat-cell *matCellDef="let order">
          <button
            matIconButton
            aria-label="expand row"
            (click)="toggle(order); $event.stopPropagation()"
            class="example-toggle-button"
            [class.example-toggle-button-expanded]="isExpanded(order)">
            <mat-icon>keyboard_arrow_down</mat-icon>
          </button>
        </td>
      </ng-container>

      <ng-container matColumnDef="expandedDetail">
        <td mat-cell *matCellDef="let order" [attr.colspan]="columnsToDisplayWithExpand.length">
          <div class="example-element-detail-wrapper"
            [class.example-element-detail-wrapper-expanded]="isExpanded(order)">
            <div class="example-element-detail">
              
              @for (item of order.details; track $index) {
                <mat-card class="item-card">
                  <mat-card-header><b>Product #{{ item.product_id }}</b></mat-card-header>
                  <mat-card-content class="item-card-details">
                    <div class="order-header">
                      @if (item.product.image_url === null) {
                        <img src="assets/no-image.png" alt="product image" class="item-img"/>
                      }@else {
                        <img [src]="item.product.image_url" alt="product image" class="item-img"/>
                      }
                      <div class="item-desc">
                        <span class="item-name">{{ item.product?.name }} </span>
                        <span>Stock: {{ item.product?.stock }}</span>
                      </div>
                    </div>
                    <p class="item-info">{{ item.pieces }} x {{ item.unit_price | currency }}</p>
                  </mat-card-content>
                </mat-card>
              }
              @if (!order.details?.length) {
                <div class="empty-detail">
                  No products in this order.
                </div>
              }


            </div>
          </div>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="columnsToDisplayWithExpand"></tr>
      <tr mat-row *matRowDef="let order; columns: columnsToDisplayWithExpand;"
          class="example-element-row"
          [class.example-expanded-row]="isExpanded(order)"
          (click)="toggle(order)">
      </tr>
      <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="example-detail-row"></tr>
    </table>
  </div>

  <mat-paginator
    class="paginator"
    [length]="totalItems"
    [pageSize]="pageSize"
    [pageIndex]="pageIndex"
    [pageSizeOptions]="[5, 10, 20, 50]"
    (page)="onPageChange($event)">
  </mat-paginator>
</main>
